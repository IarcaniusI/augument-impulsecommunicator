# README

## /r/Pikabu

**Лига Киборгов** представляет:
Теперь у каждого имеется возможность стать человеческим организмом, усиленным робототехническими аугументациями и кибернетическими имплантами.

Робототехнические аугументации позволят ускорить рутиные операции взаимодействия с окружением, (например, теперь можно автоматически посылать в ответ любого пославшего), позволяя существенно ускорить собственные возможности.

Кибернетические имплантаты позволят произвести быстрый анализ окружения и сообщить необходимую информацию, без непосредственного взаимодействия с окружением (например, можно быстро узнать о концетрации посыланий в определённых местах, благодаря появлению соответствующих сообщений в личке, что позволит быстро присоединиться к вечеринке).

## Аугументация: импульсный коммуникатор

В данном хранилище расположен импульсный коммуникатор - аугументация, позволяющая обнаруживать сигналы, испускаемые ботами при их появлении и автоматически коммуницировать с ними.
Для аугументации указываются имена ботов, при появлении которых происходит ответ самому боту или призвавшему его.

## Эксплуатация

#### Windows

Необходимо скачать для Windows архив:
 - [augument-impulsecommunicator_1.0.0.zip](https://github.com/IarcaniusI/augument-impulsecommunicator/files/4921436/augument-impulsecommunicator_1.0.0.zip)

После разархивации в каталоге должен находиться:
 - ```augument-impulsecommunicator.exe``` - выполняемый файл;
 - ```auth.conf``` - файл с настройками подключения;
 - ```run.conf``` - файл с настройками выражений и ответов на них;
 - ```praw.ini``` - файл с настройками Reddit-модуля (лучше не изменять).

Для запуска достаточно запустить ```.exe``` файл, с расположенными рядом и подстроенными ```auth.conf``` и ```run.conf```. Анализ сообщений производится только пока файл запущен. После изменения в файлах настроек необходимо выполнить перезапуск.

Для завершения процесса можно нажать комбинацию клавиш ```Ctrl```+```C```.

Далее, можно переходить к разделу [Настройка соединения](#настройка-соединения)

#### Linux, как бинарный файл

Необходимо скачать для Linux архив:
 - [augument-impulsecommunicator_amd64_1.0.0.tar.gz](https://github.com/IarcaniusI/augument-impulsecommunicator/files/4921439/augument-impulsecommunicator_amd64_1.0.0.tar.gz)

После разархивации в каталоге должен находиться:
 - ```augument-impulsecommunicator``` - выполняемый файл;
 - ```auth.conf``` - файл с настройками подключенияж
 - ```run.conf``` - файл с настройками выражений и ответов на нихж
 - ```praw.ini``` - файл с настройками Reddit-модуля (лучше не изменять).

Исполняемый файл ```augument-impulsecommunicator``` имеет следующие аргументы командной строки:
 - ```-h```, ```--help``` - справка с описанием аргументов;
 - ```-r```, ```--run``` ```RUNFILE``` - путь до файла с настройками выражений (по умолчанию ```./run.conf```);
 - ```-a```, ```--auth``` ```AUTHFILE``` - путь до файла с настройками подключения (по умолчанию ```./auth.conf```);
 - ```-n```, ```--no-notify``` - отключить сообщения о событиях и ответах (например, для экономии места на диске для логов);

При запуске без аргументов конфигурационные файлы должны находиться рядом с бинарным. Анализ сообщений производится только пока файл запущен. После изменения в файлах настроек необходимо выполнить перезапуск.

Для завершения процесса можно нажать комбинацию клавиш ```Ctrl```+```C```.

Далее, можно переходить к разделу [Настройка соединения](#настройка-соединения)

#### Linux, как сервис для supervisord

Предварительно должны быть установлены пакеты:
 - [python3](https://www.python.org/)
 - [supervisor](http://supervisord.org/)

Требуется установить следующие модули для ```Python 3```:
 - ```praw```
 - ```prawcore```

Выкачиваем репозиторий, после чего раскладываем файлы следующим образом:
 - ```augument-impulsecommunicator.py``` в каталог ```/usr/local/bin/```
 - ```run.conf``` и ```auth.conf``` в каталог ```/usr/local/etc/augument-impulsecommunicator/```
 - ```augument-impulsecommunicator.conf``` в каталог ```/etc/supervisor/conf.d/```

В описанном файле ```augument-impulsecommunicator.conf``` предполагается запуск сервиса от пользователя ```cyborg```. 
Поэтому для успешной работы необходимо сделать одно из следующих действий:
 - создать в системе пользователя с именем ```cyborg```;
 - изменить в файле ```augument-impulsecommunicator.conf``` значение переменной ```user``` на имя существующего пользователя.

Добавляем новообразовавшийся сервис путём выполнения следующих команд:
```
supervisorctl reread
supervisorctl add augument-impulsecommunicator
```

Посмотреть на статус сервисов можно командой:
```
supervisorctl status
```

Произвести запуск, остановку и перезапуск сервиса для пересчитывания конфигов можно с помошью следующих команд:
```
supervisorctl start augument-impulsecommunicator
supervisorctl stop augument-impulsecommunicator
supervisorctl restart augument-impulsecommunicator
```

Логи будут писаться через ```rsyslog```, как правило это делается в файл ```/var/log/syslog```.

Далее, можно переходить к разделу [Настройка соединения](#настройка-соединения)

## Настройка соединения

Сперва необходимо дать Reddit сгенерировать ключ. Для этого требуется:
1. Зайти в свой аккаунт на Reddit и перейти по ссылке [www.reddit.com/prefs/apps](https://www.reddit.com/prefs/apps);
1. Нажать кнопку ```Create another app...``` (```Создать другое приложение...```);
1. В поле ```name``` (```имя```) вбить название, к примеру ```auguments-and-implants```;
1. Выбрать переключатель ```script``` (```сценарий```);
1. В поле ```redirect uri``` (```uri переадресации```) вбить ссылку для перенаправления, например [www.example.com/unused/redirect/uri](http://www.example.com/unused/redirect/uri);
1. По желанию заполнить поля ```description``` (```описание```) и ```about url``` (```о url```);
1. Нажать кнопку ```create app``` (```создать приложение```);
1. Из появившейся карточки необходимо скопировать:
    - ID, расположенный под надписью ```personal use script``` (```скрипт для личного пользования```);
    - секретный ключ, расположенный рядом с надписью ```secret``` (```секрет```).

После того как данная последовательность действий выполнена, полученными настройками можно пользоваться и для других обработчиков.

Теперь необходимо занести соответствующие настройки в ```auth.conf``` файл. Пример файла:
```
{
    "user_agent": "augument-impulsecommunicator (/u/myuser)",
    "client_id": "braEnm4E3V9D01",
    "client_secret": "3F9dfp2_CspmeVd81Dkepvnwl3D",
    "username": "myuser",
    "password": "mypassword",
    "subreddit": "Pikabu"
}
```
Здесь в настройках указывается:
 - ```user_agent``` - общее имя программы и имя пользователя;
 - ```client_id``` - ID, скопированный ранне;
 - ```client_secret``` - секретный ключ, скопированный ранее;
 - ```username``` - имя пользователя;
 - ```password``` - пароль, для входа в аккаунт;
 - ```subreddit``` - название саба, к которому происходит подключение;

## Составление правил

Правила описываются в файле ```run.conf```. Рассмотреть составление правил можно на следующем примере:
```
[
    {
        "bot_name": "Vredditdownloader",
        "reply_on": "both",
        "reply_to": "bot",
        "answers": [
            "bad bot, у нас тут схорони с REC есть", "bad bot, нам своих железок хватает",
            "bad bot, схорони - мочи конкурента"
        ]
    },
    {
        "bot_name": "RECabu",
        "reply_on": "comment",
        "reply_to": "invoker",
        "answers": [
            "А зачем его звать? Он и сам придёт."
        ]
    }
]
```

В примере присутствуют 2 правила, заключённых в фигурные скобки.
У кадого правила присутствует параметр ```bot_name```, в котором указывается имя отслеживаемого бота.

Параметр ```reply_on``` регулирует на какие именно ответы бота надо отвечать. Возможные значения:

| Значение | Поведение  |
| -------- |:----------:|
| comment | Просматривать только сообщения бота, оставленные в ответ на чей-то коммент |
| post    | Просматривать только сообщения бота, оставленные в ответ на пост           |
| both    | Просматривать все виды сообщений бота                                      |

Параметр ```reply_to``` отвечает за то, кому именно посылается ответ - самому боту, или пользователю призвавшему ему. Возможные значения:

| Значение | Поведение  |
| -------- |:----------:|
| bot      | Ответить боту                          |
| invoker  | Ответить пользователю, призвавшему его |

Логично, что не имеет смысла параметру ```reply_to``` ставить значение ```invoker``` при
```reply_on``` с установленным значением  ```post```, так как тогда анализируется ответы
бота постам, и его в таких случаях никто не вызывает, он сам приходит.

В списке ```answers``` необходимо указывать ответы для бота или призвавшего его пользователя, из которых каждый раз выбирается сообщение случайным образом. В случае если в списке ```answers``` только один ответ, то каждый раз именно он и выбирается.

```
В качестве параметров для bot_name не стоит указывать имена пользователей, так как в таком случае вас могут забанить.
```

## Разработчикам

### Компиляция

Для компиляции необходимо установить модули для ```Python3```:
 - ```pyinstaller```

Для сборки выполняем команду:
```
pyinstaller ./augument-impulsecommunicator.py --onefile
```

Бинарный файл будет распологаться в новосозданном каталоге ```dist```, откуда его необходимо достать.
После сборки можно удалить как ненужные следующие объекты:
- каталог ```__pycache__```;
- каталог ```build```;
- каталог ```dist```;
- файлы с расширением ```.spec```.

Рядом с получившимся бинарным файлом необходимо рядом положить файл ```praw.ini```, поставляемый вместе с модулем ```praw```.
